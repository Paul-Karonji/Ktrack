# K-Track Pentest Report

Date: 15 February 2026  
Tester: Codex (GPT-5)  
Target: Local development instance (`http://localhost:3001`) of the K-Track Task Management backend and React SPA.

---

## 1. Scope & Objectives

**In scope**
- Express/MySQL backend API (`/api/*`) including authentication, tasks, messaging, files, analytics, guest-clients, and notifications modules.
- Supporting assets: local `/uploads` fallback, static health/public endpoints.
- User roles: Admin (`paultutorw@gmail.com`) and Client (`client@gmail.com`), plus freshly created test accounts.

**Out of scope**
- Third-party services (Cloudflare R2, Resend) beyond interactions exercised via the API.
- Frontend SPA logic (only interacted via API calls).

**Objectives**
1. Identify authentication/authorization bypasses (IDOR, privilege escalation).
2. Validate file/message confidentiality and cross-tenant isolation.
3. Verify input validation, CSRF protections, and rate limiting on critical flows.
4. Confirm previously reported issues remain fixed after code updates.

---

## 2. Methodology

| Phase | Activities / Tools |
| --- | --- |
| Recon | `Invoke-WebRequest`, `curl`, custom Node scripts (`backend/scripts/repro_*`), manual API enumeration |
| Auth Testing | Registration/login attempts, CSRF token harvesting, session cookie inspection |
| Authorization Testing | Cross-tenant CRUD attempts on `/api/tasks`, `/api/messages`, `/api/files`, `/api/users`, `/api/guest-clients`, `/api/analytics` |
| Storage & Messaging | File upload/download tests (both roles), message send/read attempts |
| Automation | Ran regression PoCs: `repro_idor_delete`, `repro_idor_task`, `repro_idor_files`, `repro_idor_message`, `repro_notifications` |
| Reporting | Consolidated results in this document |

All tests were executed in PowerShell with direct HTTP calls and helper scripts. Every exploit attempt was followed by cleanup (e.g., toggled payment back, removed temp files, noted test user IDs).

---

## 3. Findings Summary

| ID | Title | Severity | Status |
| --- | --- | --- | --- |
| F-01 | Notifications endpoints returned 500 | Medium | **Fixed** – both `/api/notifications` and `/api/notifications/unread-count` now return 200 |
| F-02 | Messaging IDOR (clients could read/post to others' tasks) | Critical | **Fixed** – `/api/messages/tasks/{id}` now enforces ownership (403 to attackers) |
| F-03 | File enumeration/download IDOR | Critical | **Fixed** – cross-tenant file list/download now 403; owners still receive 200 |
| F-04 | Task/payment IDORs (PUT/PATCH) | Critical | **Fixed** – cross-tenant modifications rejected (403/400), own tasks unaffected |
| F-05 | User deletion IDOR | Critical | **Fixed** – client delete attempts return 403 |

No new exploitable issues were discovered during this round. A validation inconsistency remains: cross-tenant `PUT /api/tasks/{id}` now fails with HTTP 400 due to validation happening before the ownership check. This still prevents abuse but consider responding with 403 for clarity.

---

## 4. Detailed Test Notes

### 4.1 Authentication & User Management
- Created `probe-9b11f2@example.com` via `/api/auth/register`; login blocked while status = `pending`.
- Clients cannot delete or approve other users (DELETE/PUT `/api/auth/users/:id` → 403).
- Admin-only endpoints (`/api/users`, `/api/users/stats`, `/api/users/:id/approve`) succeeded with admin JWT + CSRF.

### 4.2 Tasks, Quotes, Payments
- Client `client@gmail.com`:
  - `PUT /api/tasks/24` (own task) → 200.
  - `PUT /api/tasks/34` (someone else) → 403/400.
  - `PATCH /api/tasks/34/toggle-payment` → 403; same call on Task 24 → 200.
  - `POST /api/tasks/34/quote` → 403.
- Admin can still issue quotes and view all tasks.

### 4.3 Messaging & Notifications
- Admin posting to Task 34 succeeded; client GET/POST on same task returned 403.
- Client can still manage Task 24 conversation (200/201).
- `/api/notifications` and `/api/notifications/unread-count` now respond 200 for both roles with appropriate data (empty arrays/counts during tests).

### 4.4 File Storage
- Admin upload of `temp_upload.txt` to Task 34 succeeded; client listing/downloading that file now yields 403.
- Client listing/downloading own Task 24 files remains 200.
- Client upload attempts to Task 34 return 403.

### 4.5 Analytics & Guest Clients
- `/api/analytics/kpis` accessible only as admin (client → 403).
- `/api/guest-clients` returns data for admin (client → 403).

### 4.6 Public & Misc
- `/health` and `/api/public/stats` exposed only minimal info.
- No directory traversal or `.env` leakage observed; `/uploads/*` is not publicly accessible in this build.

---

## 5. Automation Results

Executed Node scripts in `backend/scripts`:

| Script | Result | Notes |
| --- | --- | --- |
| `repro_idor_message.js` | ✅ 403 on read/send | Attack PoC blocked |
| `repro_idor_delete.js` | ✅ 403 | User-deletion light test |
| `repro_idor_task.js` | ✅ toggle blocked; PUT returns 400 | See note under Findings |
| `repro_idor_files.js` | ✅ 403 | No cross-tenant file listing |
| `repro_notifications.js` | ✅ | Notifications APIs stable |

Command output is available in the PowerShell history from the test session (see commands run on 2026-02-15).

---

## 6. Recommendations

1. **Task update response** – consider checking ownership before validation so cross-tenant requests return 403 instead of 400.
2. **Add regression tests** – keep the provided `repro_*` scripts (or convert them into automated integration tests) in CI to catch future authz regressions.
3. **Monitor logs** – ensure Authorization headers or JWTs are masked in production logs; development logs currently include full bearer tokens.

---

## 7. Conclusion

All previously reported critical issues are now mitigated. Cross-tenant isolation for users, tasks, messages, files, and analytics is enforced, CSRF remains effective, and notifications are functional. No new critical or high-risk vulnerabilities were found in this pass.

Please retain the test accounts/data listed above if you wish to reproduce the scenarios; otherwise you can purge them via admin tools. Let me know when you want another sweep or when significant changes land.

